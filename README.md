# Проектная работа "Веб-ларек"

Стек: HTML, SCSS, TS, Webpack

Структура проекта:
- src/ — исходные файлы проекта
- src/components/ — папка с JS компонентами
- src/components/base/ — папка с базовым кодом
- src/types/ — папка с типами

Важные файлы:
- src/pages/index.html — HTML-файл главной страницы
- src/index.ts — точка входа приложения
- src/scss/styles.scss — корневой файл стилей
- src/utils/constants.ts — файл с константами
- src/utils/utils.ts — файл с утилитами

## Установка и запуск
Для установки и запуска проекта необходимо выполнить команды

```
npm install
npm run start
```

или

```
yarn
yarn start
```
## Сборка

```
npm run build
```

или

```
yarn build
```
## Данные и типы данных, используемые в приложении

Данные товара
```
interface IProduct {
  id: string;
  title: string;
  category: string;
  description: string;
  image: string;
  price: number | null;
}
```

Данные заказа
```
interface IOrderDetails {
  payment: string;
  address: string;
  email: string;
  phone: string;
  total: number;
  items: string[];
}

```

Данные успешного заказа, возвращаемые от API
```
export interface IOrderResult {
    id: string;
}
```

## Архитектура приложения
В приложении используется MVP парадигма. Код раздел на следующие слои:
- слой данных отвечат за хранение и изменение данных;
- слой отображения отвечает за отображение данных на странице;
- презентер связывает слои данных и отображения. 

## Базовый код
### Класс Api
Реализует базовую логику отправки запросов.\
Конструктор принимает:
- `baseUrl: string` — базовый адрес сервера;
- `options: RequestInit = {}` — опциональный объект с заголовками запросов.

Методы:
- `get(uri: string): Response` отправляет  GET запроса на переданный в параметрах ендпоинт и возращает промис с объектом - ответом от сервера;
- `post(uri: string, data: object, method: ApiPostMethods = 'POST'): Response` отправляет POST (метод запроса может быть переопределен заданием дополнительного параметра при вызове) запроса на сервер с переданными в параметрах данными и ендпоинтом.
- ` protected handleResponse(response: Response): Promise<object>` обрабатывает ответ от `fetch`. Если статус ответа ok, то метод возращает response.json(). Иначе — выбрасывает ошибку с текстом из поля error (если есть) или response.statusText.

### Класс EventEmitter
Класс представляет собой брокер событий. С помощью которого можно отравлять происходящие в системе события и подписываться на них.\
Класс используется в презентере для обработки событий и в слоях приложения для генерации событий.\
Основные методы, реализуемые классом, описаны интерфейсом `IEvents`:
- `on`: подписка на событие;
- `emit`: инициализация события;
- `trigger`: вызов функции, инициализирующей требуемое в параметрах событие.
Дополнительно реализованы методы `off`, `onAll` и  `offAll`  — для отписки от события, подписки на все события и сброса всех
подписчиков.

## Слой данных
### Класс CatalogModel
Класс отвечает за хранение и логику работы с каталогом товаров.\
Конструктор класса принимает инстант брокера событий.\
Поля класса:
- `items: IProduct[]` — список всех товаров сервиса (установка списка происходит через сеттер, который также вызывает событие обновления);
- `preview: string \| null` — ID товара, выбранного для предпросмотра;
- `events: IEvents` — экземпляр класса `EventEmitter` для инициации событий при изменении данных.

Методы:
- `getProduct(id: string): IProduct | undefined` возвращает товар по ID или undefined, если товар не найден;
- `setPreview(id: string | null): void` устанавливает ID товара для предпросмотра или очищает выбор, если null.

### Класс BasketModel
Класс отвечает за хранение и логику работы с корзиной товаров.\
Конструктор класса принимает инстант брокера событий.\
Поля класса:
- `items: string[]` —  товары в корзине;
- `totalPrice: number` — общая стоимость товаров в корзине;
- `totalProductNumber: number` — общее количество товаров;

Методы класса:
- `add(id: string): void` добавляет товар с указанным ID в корзину;
- `remove(id: string): void` удаляет товар с указанным ID из корзины;
- `clear(): void` очищает корзину, удаляя все товары и сбрасывая счетчики.

После всех методов генерируется событие изменения корзины. 

### Класс OrderModel
Класс отвечает за хранение и валидацию данных заказа.\
Конструктор класса принимает инстант брокера событий.\
Поля класса:
- `order: IOrderDetails` — данные заказа: способ оплаты, адрес, email, телефон, список товаров и общая стоимость;
- `formErrors: Partial<Record<keyof IOrderDetails, string>>` — ошибки валидации полей формы.

Методы класса:
- `updateOrderField(field: keyof IOrderDetails, value: string): void` обновляет поле данных заказа и генерирует событие при изменении;
- `'updateBasketData(items: string[], total: number): void'` обновляет в заказе информацию о содержимом заказа: массив товаров и итоговую стоимость;
- `validate(): boolean` проверяет корректность заполнения всех  полей форм, обновляет `formErrors` и генерирует событие об ошибках;
- `getOrder(): IOrderDetails` возвращает данные заказа, если они валидны;
- `clear(): void` удаляет данные заказа.

## Слой отображения
Все классы представления отвечают за отображение внутри контейнера передаваемых в них данных.

### Класс Component
Абстрактный базовый класс для UI-компонентов, предоставляющий вспомогательные методы для взаимодействия с DOM.

Используется как родительский класс для других классов отображения для упрощения реализации рендеринга и манипуляций с DOM.

Поля: 
- `container: HTMLElement` — корневой DOM-элемент компонента, заданный в конструкторе.

Методы: 
- `render(data?: Partial<T>): HTMLElement` обновляет свойства компонента на основе переданных данных и возвращает корневой DOM-элемент;
- `toggleClass(element: HTMLElement, className: string, force?: boolean): void` добавляет или удаляет CSS-класс у элемента;
- `setText(element: HTMLElement, value: unknown): void` устанавливает текстовое содержимое для DOM-элемента;
- `setDisabled(element: HTMLElement, state: boolean): void` устанавливает или снимает атрибут disabled у элемента формы;
- `setHidden(element: HTMLElement): void` скрывает элемент, устанавливая CSS-свойство display: none;
- `setVisible(element: HTMLElement): void` показывает ранее скрытый элемент, удаляя свойство display;
- `setImage(element: HTMLImageElement, src: string, alt?: string): void` устанавливает src и (опционально) alt для изображения.

### Класс Card
Базовый класс для отображения карточки товара с основными элементами: заголовок и цена.

Конструктор:
- `blockName: string` — CSS-класс блока для поиска элементов внутри контейнера;
- `container: HTMLElement` — корневой DOM-элемент карточки;
- `actions?: ICardActions` — объект с обработчиками событий.

Поля:
- `_title: HTMLElement` — элемент заголовка карточки;
- `_price: HTMLElement` — элемент отображения цены;
- `_button: HTMLButtonElement` — кнопка для добавления / удаления товара.

Свойства:
- `id: string` — идентификатор карточки.

В классе используются методы из базового класса Component для установки текста элементам.

### Класс CatalogItem
Расширение базового класса Card для карточки каталога, добавляющее отображение изображения товара и категории.

Конструктор:
- `container: HTMLElement` — корневой DOM-элемент карточки.
- `actions?: ICardActions` — объект с обработчиками событий.

Поля:
- `_image: HTMLImageElement` — элемент изображения товара;
- `_category: HTMLElement` — элемент отображения категории товара.

В классе используются методы из базового класса Component для установки текста и изображения элементам.

### Класс CardPreview 
Расширение класса Card, добавляющее отображение изображения, описания и категории товара и кнопку для добавления / удаления товара. Предназначен для показа детального превью товара.

Конструктор:
- `container: HTMLElement` — корневой DOM-элемент карточки.
- `actions?: ICardActions` — объект с обработчиками событий, например, для обработки кликов по кнопке.

Поля:
- `_description: HTMLElement` — элемент для отображения описания товара;
- `_image: HTMLImageElement` — элемент изображения товара;
- `_category: HTMLElement` — элемент отображения категории товара.

Методы:
- `setButtonText(value: string): void` меняет текст кнопки в зависимости от наличия / отсутствия товара в корзине;

В классе используются методы из базового класса Component для установки текста и изображения элементам.

### Класс BasketItem
Расширение класса Card, добавляющее отображение кнопки удаления товара из корзины.

Конструктор:
- `container: HTMLElement` — корневой DOM-элемент карточки.
- `actions?: ICardActions` — объект с обработчиками событий, например, для обработки кликов по кнопке.

Поля:
- `_index: HTMLElement` — элемент номера товара в корзине.

В классе используются методы из базового класса Component для установки текста элементам.

### Класс Modal
Класс Modal реализует модальное окно с функционалом открытия, закрытия и управления содержимым.

Конструктор
- `container: HTMLElement` — корневой DOM-элемент модального окна;
- `events: IEvents` — объект для работы с событиями.

Поля
- `_closeButton: HTMLButtonElement` — кнопка закрытия модального окна.
- `_content: HTMLElement`— контейнер для содержимого модального окна.

Методы
- `open(): void` открывает модальное окно;
- `close(): void` закрывает модальное окно, очищает содержимое;
- `render(data: IModalData): HTMLElement` рендерит данные в модальное окно, открывает его и возвращает корневой элемент;
- сеттер для установления значения поля `_content`.

При каждом изменении модального окна генерируется соответствующее событие.

### Класс Basket
Класс Basket реализует визуальное отображение корзины покупок, включая список товаров, итоговую сумму и кнопку для оформления заказа.

Конструктор:
- `container: HTMLElement` — корневой DOM-элемент корзины;
- `events: EventEmitter` — объект для генерации и обработки пользовательских событий.

Поля: 
- `_items: HTMLElement` — элемент списка товаров в корзине;
- `_total: HTMLElement `— элемент отображения общей суммы;
- `_button: HTMLElement` — кнопка оформления заказа;
- `events: EventEmitter` — объект для отправки событий.

Методы
Cеттеры `items` и `total` для установления значений.

### Класс Form<T>
Класс Form реализует универсальную обёртку над HTML-формой. Позволяет управлять её состоянием, отслеживать изменения в полях и инициировать события на основе ввода пользователя.

Конструктор: 
- `container: HTMLFormElement` — HTML-форма, к которой будет привязан функционал;
- `events: IEvents` — объект для работы с событиями.

Поля:
- `_submit: HTMLButtonElement` — кнопка отправки формы;
- `_errors: HTMLElement` — контейнер для вывода сообщений об ошибках;
- `container: HTMLFormElement ` — форма;
- `events: IEvents` — объект для работы с событиями.

Методы:
- `onInputChange(field: keyof T, value: string): void` — метод, вызываемый при каждом вводе в поле формы, генерирует  соответствующее событие;
- `render(state: Partial<T> & IFormState): HTMLElement` отвечает за отображение данных и валидационного состояния;
- сеттеры для установления состояния кнопки и текста ошибок.

### Класс OrderFormView
Класс для управления формой заказа с полями адреса и выбора способа оплаты. Расширение класса Form.

Конструктор: 
- `container: HTMLFormElement` — HTML-форма, к которой будет привязан функционал;
- `events: IEvents` — объект для работы с событиями.

Поля:
- `'_paymentButtons'`: HTMLButtonElement[] — список кнопок выбора способа оплаты (онлайн или при получении);
- `'_selectedPayment: 'card' | 'cash' | null'` — текущее выбранное значение оплаты.

Сеттеры:
-`payment: 'card' | 'cash'` устанавливает выбранный способ оплаты. Визуально выделяет выбранную кнопку, добавляя ей модификатор класса `button_alt-active`;
- `address: string` устанавливает значение поля "адрес доставки".

### Класс ContactsFormView
Класс для управления формой контактов с полями почты и телефона. Расширение класса Form.

Конструктор: 
- `container: HTMLFormElement` — HTML-форма, к которой будет привязан функционал;
- `events: IEvents` — объект для работы с событиями.

Сеттеры:
- `phone: string` устанавливает значение поля "телефон";
- `email: string` устанавливает значение поля "email".

### Класс Success
Класс Success отвечает за отображение экрана успешного оформления заказа. Компонент отображает сумму заказа и предоставляет кнопку для продолжения работы.

Конструктор:
- `container: HTMLElement` — корневой HTML-элемент, в который отрисовывается компонент;
- `actions: ISuccessActions` — объект с обработчиком пользовательского действия.

Поля:
- `_close: HTMLElement` — DOM-элемент кнопки действия.

### Класс Page
Класс Page представляет основную страницу приложения и управляет её ключевыми элементами: каталогом товаров, счётчиком корзины, оберткой страницы и элементом корзины.

Конструктор:
- `container: HTMLElement` — корневой HTML-элемент, в который отрисовывается компонент;
- `actions: ISuccessActions` — объект с обработчиком пользовательского действия.

Поля:
- `_counter: HTMLElement` — элемент отображения количества товаров в корзине в шапке;
- `_catalog: HTMLElement` — контейнер для карточек товаров в каталоге;
- `_wrapper: HTMLElement` — основной блок страницы;
- `_basket: HTMLElement `— кнопка открытия корзины в шапке.

Методы:
- сеттер `counter(value: number)` обновляет текст счётчика корзины;
- сеттер ` catalog(items: HTMLElement[])` заменяет содержимое каталога карточками товаров;
- сеттер `locked(value: boolean)` управляет свойством блокировки/разблокировки прокрутки страницы.

## Слой коммуникации
### Класс AppApi
Принимает в конструктор экземпляр класса Api и предоставляет методы реализующие взаимодействие с бэкендом сервиса.

Конструктор: 
- `cdn: string` — базовый путь к CDN, используется для генерации абсолютных ссылок на изображения;
- `baseUrl: string` — базовый URL API;
- `options?: RequestInit` — настройки запросов.

Методы:
- `getProductsList(): Promise<IProduct[]>` получает список всех продуктов с сервера;
- `getProductItem(id: string): Promise<IProduct>` получает данные о конкретном продукте по его идентификатору id;
- `orderProducts(order: IOrderDetails): Promise<IOrderResult>` отправляет данные заказа на сервер.

## Взаимодействие компонентов
Код, описывающий взаимодействие представления и данных между собой находится в файле `index.ts`, выполняющем роль презентера.\
Взаимодействие осуществляется за счет событий генерируемых с помощью брокера событий и обработчиков этих событий, описанных в `index.ts`\
В `index.ts` сначала создаются экземпляры всех необходимых классов, а затем настраивается обработка событий.

**Список всех событий, которые могут генерироваться в системе:**\
*События изменения данных (генерируются классами моделями данных)*
- `'catalog:changed'`\
Генерируется: при обновлении списка товаров (`CatalogModel`).\
Действие: Обновить каталог на странице — перерисовать карточки товаров.
- `'preview:changed'`\
Генерируется при установке товара в режим предпросмотра (`CatalogModel`).\
Действие: Открыть модальное окно с детальной информацией о товаре.
- `'basket:changed'`\
Генерируется при добавлении, удалении товара или очистке корзины (`BasketModel`).\
Действие: Обновить список товаров в корзине, пересчитать итоговую сумму и обновить счётчик товаров в шапке; перерисовать корзину.
- `'order:errors'`\
Генерируется при невалидных данных в форме (`OrderModel`).\
Действие: Показать / скрыть сообщения об ошибках в полях формы заказа.

*События, возникающие при взаимодействии пользователя с интерфейсом (генерируются классами, отвечающими за представление)*
- `'card:select'`\
Генерируется при клике по карточке товара (`CatalogItem`).\
Действие: Установить выбранный товар в `CatalogModel.preview`, что вызовет `preview:changed`.
- `'card:add'`\
Генерируется при клике на кнопку «В корзину» (`CardPreview`).\
Действие: Добавить товар в корзину через `BasketModel.add()`, затем сработает `basket:changed`.
- `'card:remove'`\
Генерируется при клике на кнопку удаления (`CardPreview` или `BasketItem`).\
Действие: Удалить товар из корзины через `BasketModel.remove()`, затем сработает `basket:changed`.
- `'basket:open'`\
Генерируется при клике по иконке корзины (`Page`).\
Действие: Открыть модальное окно с содержимым корзины, заблокировать прокрутку.
- `'basket:close'`\
Генерируется при клике по крестику или по оверлею (`Page`).\
Действие: Закрыть модальное окно с содержимым корзины, разблокировать прокрутку.
- `'form:order:open'`\
Генерируется при клике по кнопке "Оформить" (`Page`).\
Действие: Открыть модальное окно с формой, заблокировать прокрутку.
- `'form:order:close'`\
Генерируется при клике по крестику или по оверлею (`Page`).\
Действие: Закрыть модальное окно с содержимым формы, очистить форму, разблокировать прокрутку.
- `form:contacts:open`\
Генерируется при нажатии на кнопку "Далее" в форме `Order`.\
Действие: Открыть форму с контактными данными `Contacts`, заблокировать прокрутку.
- `'form:contacts:close'`\
Генерируется при клике по крестику или по оверлею (`Page`).\
Действие: Закрыть модальное окно с содержимым формы, очистить форму, разблокировать прокрутку.
-`'form:order.{field}:change'`
Генерируется при изменении полей формы заказа (address, payment).
Действие: Обновить соответствующее поле в `OrderModel`.
-`'form:contacts.{field}:change'`
Генерируется: при изменении полей формы контактов (email, phone).
Действие: Обновить соответствующее поле в `OrderModel`.
- `'order:submit'`\
Генерируется после успешной валидации формы.\
Действие: Отправить заказ `AppApi`, открыть окно успешного оформления заказа и очистить корзину.
- `'modal:open'`\
Генерируется при открытии любого модального окна.
Действие: Блокирует прокрутку страницы.
- `'modal:close'`\
Генерируется при закрытии любого модального окна.
Действие: Разблокирует прокрутку страницы